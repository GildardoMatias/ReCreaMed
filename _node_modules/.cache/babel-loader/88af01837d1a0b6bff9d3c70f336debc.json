{"ast":null,"code":"var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { deepMix } from '@antv/util';\nimport { max as d3Max, mean as d3Mean, sum as d3Sum, min as d3Min, median as d3Median } from 'd3-array';\nimport { indexOf } from '../utils/array';\nimport { columnOf, column, nonConstantColumn } from './utils/helper';\nfunction builtinFormatter(summary) {\n  return d => d === null ? summary : \"\".concat(summary, \" of \").concat(d);\n}\nfunction normalizeReducer(reducer) {\n  if (typeof reducer === 'function') return [reducer, null];\n  const registry = {\n    mean,\n    max,\n    count,\n    first,\n    last,\n    sum,\n    min,\n    median\n  };\n  const reducerFunction = registry[reducer];\n  if (!reducerFunction) throw new Error(\"Unknown reducer: \".concat(reducer, \".\"));\n  return reducerFunction();\n}\nfunction mean() {\n  const reducer = (I, V) => d3Mean(I, i => +V[i]);\n  const formatter = builtinFormatter('mean');\n  return [reducer, formatter];\n}\nfunction median() {\n  const reducer = (I, V) => d3Median(I, i => +V[i]);\n  const formatter = builtinFormatter('median');\n  return [reducer, formatter];\n}\nfunction max() {\n  const reducer = (I, V) => d3Max(I, i => +V[i]);\n  const formatter = builtinFormatter('max');\n  return [reducer, formatter];\n}\nfunction min() {\n  const reducer = (I, V) => d3Min(I, i => +V[i]);\n  const formatter = builtinFormatter('min');\n  return [reducer, formatter];\n}\nfunction count() {\n  const reducer = (I, V) => I.length;\n  const formatter = builtinFormatter('count');\n  return [reducer, formatter];\n}\nfunction sum() {\n  const reducer = (I, V) => d3Sum(I, i => +V[i]);\n  const formatter = builtinFormatter('sum');\n  return [reducer, formatter];\n}\nfunction first() {\n  const reducer = (I, V) => V[I[0]];\n  const formatter = builtinFormatter('first');\n  return [reducer, formatter];\n}\nfunction last() {\n  const reducer = (I, V) => V[I[I.length - 1]];\n  const formatter = builtinFormatter('last');\n  return [reducer, formatter];\n}\n/**\n * The Group transform group data by x and y channels, and aggregate.\n */\nexport const GroupN = function () {\n  let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  const {\n      groupBy\n    } = options,\n    rest = __rest(options, [\"groupBy\"]);\n  return (I, mark) => {\n    const {\n      data,\n      encode\n    } = mark;\n    const groups = groupBy(I, mark);\n    if (!groups) return [I, mark];\n    // Extract field from from channel\n    // x1 from x, y1 from y, etc,.\n    const maybeFrom = (field, reducer) => {\n      if (field) return field;\n      const {\n        from\n      } = reducer;\n      if (!from) return field;\n      const [, field1] = columnOf(encode, from);\n      return field1;\n    };\n    const outputs = Object.entries(rest).map(_ref => {\n      let [channel, reducer] = _ref;\n      const [reducerFunction, formatter] = normalizeReducer(reducer);\n      const [V, field] = columnOf(encode, channel);\n      const field1 = maybeFrom(field, reducer);\n      const RV = groups.map(I => reducerFunction(I, V !== null && V !== void 0 ? V : data));\n      return [channel, Object.assign(Object.assign({}, nonConstantColumn(RV, (formatter === null || formatter === void 0 ? void 0 : formatter(field1)) || field1)), {\n        aggregate: true\n      })];\n    });\n    const reducedColumns = Object.keys(encode).map(key => {\n      const [V, fv] = columnOf(encode, key);\n      const GV = groups.map(I => V[I[0]]);\n      return [key, column(GV, fv)];\n    });\n    const GD = groups.map(I => data[I[0]]);\n    const GI = indexOf(groups);\n    return [GI, deepMix({}, mark, {\n      data: GD,\n      encode: Object.fromEntries([...reducedColumns, ...outputs])\n    })];\n  };\n};\nGroupN.props = {};","map":{"version":3,"names":["deepMix","max","d3Max","mean","d3Mean","sum","d3Sum","min","d3Min","median","d3Median","indexOf","columnOf","column","nonConstantColumn","builtinFormatter","summary","d","concat","normalizeReducer","reducer","registry","count","first","last","reducerFunction","Error","I","V","i","formatter","length","GroupN","options","arguments","undefined","groupBy","rest","__rest","mark","data","encode","groups","maybeFrom","field","from","field1","outputs","Object","entries","map","_ref","channel","RV","aggregate","reducedColumns","keys","key","fv","GV","GD","GI","fromEntries","props"],"sources":["src/transform/groupN.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module"}