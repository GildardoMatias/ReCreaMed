{"ast":null,"code":"import { Canvas as GCanvas, Group } from '@antv/g';\nimport { Renderer as CanvasRenderer } from '@antv/g-canvas';\nimport { Plugin as DragAndDropPlugin } from '@antv/g-plugin-dragndrop';\nimport { deepMix } from '@antv/util';\nimport EventEmitter from '@antv/event-emitter';\nimport { select } from '../utils/selection';\nimport { ChartEvent } from '../utils/event';\nimport { error } from '../utils/helper';\nimport { plot } from './plot';\nimport { VIEW_CLASS_NAME } from './constant';\n/**\n * Infer key for each node of view tree.\n * Each key should be unique in the entire view tree.\n * The key is for incremental render when view tree is changed.\n * @todo Fix custom key equals to inferred key.\n */\nfunction inferKeys(options) {\n  const root = deepMix({}, options);\n  const nodeParent = new Map([[root, null]]);\n  const nodeIndex = new Map([[null, -1]]);\n  const discovered = [root];\n  while (discovered.length) {\n    const node = discovered.shift();\n    // If key of node is not specified, using parentKey and the index for it\n    // in parent.children as its key.\n    // e.g. The key of node named 'a' will be 'a', and the key of node named\n    // 'b' will be 'parent-1' in the following view tree specification.\n    // { key: 'parent', children: [{ name: 'a', key: 'a' }, { name: 'b' }] }\n    if (node.key === undefined) {\n      const parent = nodeParent.get(node);\n      const index = nodeIndex.get(node);\n      const key = parent === null ? \"\".concat(0) : \"\".concat(parent.key, \"-\").concat(index);\n      node.key = key;\n    }\n    const {\n      children = []\n    } = node;\n    if (Array.isArray(children)) {\n      for (let i = 0; i < children.length; i++) {\n        // Clone node as well.\n        const child = deepMix({}, children[i]);\n        children[i] = child;\n        nodeParent.set(child, node);\n        nodeIndex.set(child, i);\n        discovered.push(child);\n      }\n    }\n  }\n  return root;\n}\nfunction Canvas(width, height) {\n  const renderer = new CanvasRenderer();\n  // DragAndDropPlugin is for interaction.\n  renderer.registerPlugin(new DragAndDropPlugin());\n  return new GCanvas({\n    width,\n    height,\n    container: document.createElement('div'),\n    renderer: renderer\n  });\n}\nexport function render(options) {\n  let context = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  let resolve = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : () => {};\n  let reject = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : e => {\n    throw e;\n  };\n  // Initialize the context if it is not provided.\n  const {\n    width = 640,\n    height = 480,\n    depth = 0\n  } = options;\n  const keyed = inferKeys(options);\n  const {\n    canvas = Canvas(width, height),\n    emitter = new EventEmitter(),\n    library\n  } = context;\n  context.canvas = canvas;\n  context.emitter = emitter;\n  const {\n    width: prevWidth,\n    height: prevHeight\n  } = canvas.getConfig();\n  if (prevWidth !== width || prevHeight !== height) {\n    canvas.resize(width, height);\n  }\n  emitter.emit(ChartEvent.BEFORE_RENDER);\n  // Plot the chart and mutate context.\n  // Make sure that plot chart after container is ready for every time.\n  const selection = select(canvas.document.documentElement);\n  canvas.ready.then(() => plot(Object.assign(Object.assign({}, keyed), {\n    width,\n    height,\n    depth\n  }), selection, library, context)).then(() => {\n    // Place the center of whole scene at z axis' origin.\n    if (depth) {\n      const [x, y] = canvas.document.documentElement.getPosition();\n      // Since `render` method can be called for multiple times, use setPosition instead of translate here.\n      canvas.document.documentElement.setPosition(x, y, -depth / 2);\n    }\n    // Wait for the next tick.\n    canvas.requestAnimationFrame(() => {\n      emitter.emit(ChartEvent.AFTER_RENDER);\n      resolve === null || resolve === void 0 ? void 0 : resolve();\n    });\n  }).catch(e => {\n    reject === null || reject === void 0 ? void 0 : reject(e);\n  });\n  // Return the container HTML element wraps the canvas or svg element.\n  return normalizeContainer(canvas.getConfig().container);\n}\nexport function renderToMountedElement(options) {\n  let context = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  let resolve = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : () => {};\n  let reject = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : e => {\n    throw e;\n  };\n  var _a;\n  // Initialize the context if it is not provided.\n  const {\n    width = 640,\n    height = 480\n  } = options;\n  const keyed = inferKeys(options);\n  const {\n    group = new Group(),\n    emitter = new EventEmitter(),\n    library\n  } = context;\n  if (!(group === null || group === void 0 ? void 0 : group.parentElement)) {\n    error(\"renderToMountedElement can't render chart to unmounted group.\");\n  }\n  const selection = select(group);\n  context.group = group;\n  context.emitter = emitter;\n  context.canvas = context.canvas || ((_a = group === null || group === void 0 ? void 0 : group.ownerDocument) === null || _a === void 0 ? void 0 : _a.defaultView);\n  emitter.emit(ChartEvent.BEFORE_RENDER);\n  // Plot the chart and mutate context.\n  // Make sure that plot chart after container is ready for every time.\n  plot(Object.assign(Object.assign({}, keyed), {\n    width,\n    height\n  }), selection, library, context).then(() => {\n    var _a;\n    (_a = context.canvas) === null || _a === void 0 ? void 0 : _a.requestAnimationFrame(() => {\n      emitter.emit(ChartEvent.AFTER_RENDER);\n      resolve === null || resolve === void 0 ? void 0 : resolve();\n    });\n  }).catch(e => {\n    reject === null || reject === void 0 ? void 0 : reject(e);\n  });\n  // Return the Group wraps the canvas or svg element.\n  return group;\n}\nexport function destroy(options) {\n  let context = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  let isDestroyCanvas = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n  const {\n    canvas,\n    emitter\n  } = context;\n  if (canvas) {\n    destroyAllInteractions(canvas);\n    isDestroyCanvas ? canvas.destroy() : canvas.destroyChildren();\n  }\n  emitter.off();\n}\n/**\n * Destroy all interactions mounted on the canvas.\n */\nfunction destroyAllInteractions(canvas) {\n  const viewGroups = canvas.getRoot().querySelectorAll(\".\".concat(VIEW_CLASS_NAME));\n  viewGroups === null || viewGroups === void 0 ? void 0 : viewGroups.forEach(group => {\n    const {\n      nameInteraction = new Map()\n    } = group;\n    if ((nameInteraction === null || nameInteraction === void 0 ? void 0 : nameInteraction.size) > 0) {\n      Array.from(nameInteraction === null || nameInteraction === void 0 ? void 0 : nameInteraction.values()).forEach(value => {\n        value === null || value === void 0 ? void 0 : value.destroy();\n      });\n    }\n  });\n}\nfunction normalizeContainer(container) {\n  return typeof container === 'string' ? document.getElementById(container) : container;\n}","map":{"version":3,"names":["Canvas","GCanvas","Group","Renderer","CanvasRenderer","Plugin","DragAndDropPlugin","deepMix","EventEmitter","select","ChartEvent","error","plot","VIEW_CLASS_NAME","inferKeys","options","root","nodeParent","Map","nodeIndex","discovered","length","node","shift","key","undefined","parent","get","index","concat","children","Array","isArray","i","child","set","push","width","height","renderer","registerPlugin","container","document","createElement","render","context","arguments","resolve","reject","e","depth","keyed","canvas","emitter","library","prevWidth","prevHeight","getConfig","resize","emit","BEFORE_RENDER","selection","documentElement","ready","then","Object","assign","x","y","getPosition","setPosition","requestAnimationFrame","AFTER_RENDER","catch","normalizeContainer","renderToMountedElement","group","parentElement","_a","ownerDocument","defaultView","destroy","isDestroyCanvas","destroyAllInteractions","destroyChildren","off","viewGroups","getRoot","querySelectorAll","forEach","nameInteraction","size","from","values","value","getElementById"],"sources":["src/runtime/render.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module"}